<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>ULAPPH Bot</title>

	<!-- for mobile screens -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- stylesheets are conveniently separated into components -->
	<link rel="stylesheet" media="all" href="/lib/css/chat-bubble/setup.css">
	<link rel="stylesheet" media="all" href="/lib/css/chat-bubble/says.css">
	<link rel="stylesheet" media="all" href="/lib/css/chat-bubble/reply.css">
	<link rel="stylesheet" media="all" href="/lib/css/chat-bubble/typing.css">
	<link rel="stylesheet" media="all" href="/lib/css/chat-bubble/input.css">
	<style>
	body {
		background: #dcdde0;
	}
	.bubble-container {
		height: 100vh;
	}
	.bubble-container .input-wrap textarea {
		margin: 0;
		width: calc(100% - 30px);
	}
	</style>
</head>
<body>

<!-- container element for chat window -->
<div id="chat"></div>

<!-- import the JavaScript file -->
<script src="/lib/js/chat-bubble/Bubbles.js"></script>
<script>
// initialize by constructing a named function...
// ...and add text processing plugin:
var chatWindow = new Bubbles(document.getElementById("chat"), "chatWindow", {
  // the one that we care about is inputCallbackFn()
  // this function returns an object with some data that we can process from user input
  // and understand the context of it

  // this is an example function that matches the text user typed to one of the answer bubbles
  // this function does no natural language processing
  // this is where you may want to connect this script to NLC backend.
  inputCallbackFn: function(o) {
    // add error conversation block & recall it if no answer matched
    var miss = function() {
      //ulapph
    console.log("call nlp backend");
	//call nlp
    if (window.XMLHttpRequest)
	  {// code for IE7+, Firefox, Chrome, Opera, Safari
	  xhr=new XMLHttpRequest();
	  }
	else
	  {// code for IE6, IE5
	  xhr=new ActiveXObject('MSXML2.XMLHTTP.3.0');
	  } 
	console.log(o);
	xhr.open("POST","/nlp?p=" + o.input, true); 
	xhr.send();
	
	 xhr.onreadystatechange=function()
	  {
	  if (xhr.readyState==4 && xhr.status==200)
		{
		var currVal = xhr.responseText;
			console.log(currVal);
			switch (currVal) {
				case "nlp-success-invalid-function":
					chatWindow.talk(convo, currVal);
					break;
				case "nlp-failed":
					chatWindow.talk(convo, currVal);
					break;
				default:
				  chatWindow.talk(
				    {
				      "i-dont-get-it": {
				        says: [currVal],
				        reply: o.convo[o.standingAnswer].reply
				      }
				    },
				    "i-dont-get-it"
				  )
			}
			return;
		}
	  }
    }

    // do this if answer found
    var match = function(key) {
      setTimeout(function() {
        chatWindow.talk(convo, key) // restart current convo from point found in the answer
      }, 600)
    }

    // sanitize text for search function
    var strip = function(text) {
      return text.toLowerCase().replace(/[\s.,\/#!$%\^&\*;:{}=\-_'"`~()]/g, "")
    }

    // search function
    var found = false
    o.convo[o.standingAnswer].reply.forEach(function(e, i) {
      strip(e.question).includes(strip(o.input)) && o.input.length > 0
        ? (found = e.answer)
        : found ? null : (found = false)
    })
    found ? match(found) : miss()
  }
}) // done setting up chat-bubble

// conversation object defined separately, but just the same as in the
// "Basic chat-bubble Example" (1-basics.html)
var convo = {
  ice: {
    says: ["Hi, I'm ULAPPH Bot!", "How can I help you today?"],
	  reply: [
	    {
	      question: "List functions",
	      answer: "iceListFunctions"
	    },
	    {
	      question: "All Desktops",
	      answer: "funcAllDesktops"
	    },
	    {
	      question: "Show Topic News",
	      answer: "showTopicNews"
	    }
	  ]
  },
  "iceListFunctions": {
    says: ["Here are some functions you can call:",
    			"<i>view the slide num 3</i>",
    			"<i>view the article num 3</i>",
    			"<i>view the media num 3</i>",
    			"<i>update the slide num 3</i>",
    			"<i>update the article num 3</i>",
    			"<i>update the media num 3</i>",
    			"<i>motd</i>",
    			"<i>search internal keyword</i>",
    			"<i>search external keyword</i>",
    			"<i>open the webapp</i>",
    			"<i>open the slides with music</i>",
    			"<i>open the articles with music</i>",
    			"<i>open the wallpapers</i>",
    			"<i>recent in slides, articles or media</i>",
    			"<i>recent in comments</i>",
    		"You can enter them anytime!",
    	],
    reply: []
  },
  "nlp-success-invalid-function": {
	  says: ["I understood your intention but did not match any function!", "What would like to do?"],
	  reply: [
	    {
	      question: "Open Search Widget",
	      answer: "nlpSucceedsOpenSearchWidget"
	    },
	    {
	      question: "Start Over",
	      answer: "ice"
	    }
	  ]
	},
  "nlp-failed": {
      says: ["Sorry I can't understand your intention!", "What would like to do?"],
      reply: [
	    {
	      question: "Click desktop & press Escape",
	      answer: "nlpSucceedsOpenSearchWidget"
	    },
        {
	      question: "Start Over",
	      answer: "ice"
        }
      ]
    } // end conversation object
}

showTopicNews = function () {
	//get desktop number
	//parse URL values
	var urlParams;
	var match,
			pl     = /\+/g,  // Regex for replacing addition symbol with a space
			search = /([^&=]+)=?([^&]*)/g,
			decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
			query  = window.location.search.substring(1);

	urlParams = {};
	while (match = search.exec(query))
	   urlParams[decode(match[1])] = decode(match[2]);
   
    var msg = "<a href=\"/stream?STR_FUNC=RUN_TOPICS&u=" + urlParams["u"] + "\" target=\"topicNews\">Run UWM Topics Search</a>";
	  chatWindow.talk(
	    {
	      "showTopicNewsRes": {
	        says: [msg],
	        reply: []
	      }
	    },
	    "showTopicNewsRes"
	  )

}

nlpSucceedsOpenSearchWidget = function () {
    //chatWindow.talk(convo, "<a href=\"/tools?FUNC=WIDGET&t=MiniBrowserGet\" target=\"searchwidget\">Open Search Widget</a>"); // Continue conversation
    //return;
    var msg = "<a href=\"/tools?FUNC=WIDGET&t=MiniBrowserGet\" target=\"searchwidget\">Open Search Widget</a>";
	  chatWindow.talk(
	    {
	      "nlpSucceedsOpenSearchWidgetRes": {
	        says: [msg],
	        reply: []
	      }
	    },
	    "nlpSucceedsOpenSearchWidgetRes"
	  )
}

funcAllDesktops = function () {
    var msg = "<a href=\"/tools?FUNC=ALL_DESKTOPS\" target=\"alldesk\">List All Desktops</a>";
	  chatWindow.talk(
	    {
	      "funcAllDesktopsRes": {
	        says: [msg],
	        reply: []
	      }
	    },
	    "funcAllDesktopsRes"
	  )
}
	
// pass JSON to your function and you're done!
chatWindow.talk(convo)
</script>
</body>
